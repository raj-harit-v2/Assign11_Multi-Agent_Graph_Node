========================================
DIAGRAM 1: Complete System Architecture
========================================
Copy everything below this line into Mermaid Live:

graph TB
    subgraph "Input Layer"
        User[User Query]
        Simulator[Automated Simulator]
        TestFile[Test Files]
    end
    
    subgraph "Core Agent System"
        AgentLoop[Agent Loop<br/>Main Orchestrator]
        ControlManager[Control Manager<br/>MAX_STEPS/MAX_RETRIES]
        HumanLoop[Human-in-Loop<br/>Tool & Plan Recovery]
    end
    
    subgraph "AI Processing Layer"
        Perception[Perception Module<br/>Query Understanding]
        Decision[Decision Module<br/>Planning & Strategy]
        MemorySearch[Memory Search<br/>Context Retrieval]
    end
    
    subgraph "Execution Layer"
        Executor[Action Executor<br/>Code Execution]
        MCP[Multi-MCP Servers<br/>Tool Providers]
        RetryLogic[Retry Logic<br/>MAX_RETRIES]
    end
    
    subgraph "Data Management Layer"
        CSVManager[CSV Manager<br/>Query & Performance Logging]
        SessionLog[Session Log<br/>State Persistence]
        QueryCSV[query_text.csv<br/>Query Master Table]
        PerfCSV[tool_performance.csv<br/>Performance Metrics]
    end
    
    subgraph "Output Layer"
        Statistics[Statistics Generator<br/>Performance Analysis]
        StatsMD[Result_Stats.md<br/>Analysis Report]
        FinalAnswer[Final Answer<br/>To User]
    end
    
    User --> AgentLoop
    Simulator --> AgentLoop
    TestFile --> Simulator
    
    AgentLoop --> ControlManager
    AgentLoop --> Perception
    AgentLoop --> Decision
    AgentLoop --> Executor
    AgentLoop --> CSVManager
    AgentLoop --> MemorySearch
    AgentLoop --> SessionLog
    
    Perception --> MemorySearch
    Decision --> MemorySearch
    
    Executor --> MCP
    Executor --> RetryLogic
    Executor --> HumanLoop
    RetryLogic --> HumanLoop
    
    ControlManager --> HumanLoop
    
    CSVManager --> QueryCSV
    CSVManager --> PerfCSV
    
    SessionLog --> MemorySearch
    
    PerfCSV --> Statistics
    Statistics --> StatsMD
    
    AgentLoop --> FinalAnswer
    
    style AgentLoop fill:#4a90e2,color:#fff
    style HumanLoop fill:#e74c3c,color:#fff
    style ControlManager fill:#f39c12,color:#fff
    style CSVManager fill:#27ae60,color:#fff
    style Executor fill:#9b59b6,color:#fff
    style Perception fill:#3498db,color:#fff
    style Decision fill:#3498db,color:#fff

========================================
DIAGRAM 2: Agent Loop Execution Flow
========================================
Copy everything below this line into Mermaid Live:

sequenceDiagram
    participant User
    participant AgentLoop
    participant CSVManager
    participant MemorySearch
    participant Perception
    participant Decision
    participant ControlManager
    participant Executor
    participant MCP
    participant HumanLoop
    participant SessionLog
    
    User->>AgentLoop: Submit Query
    AgentLoop->>CSVManager: Register Query (Get Query_Id)
    CSVManager-->>AgentLoop: Query_Id (Bigint)
    
    AgentLoop->>MemorySearch: Search Relevant Memory
    MemorySearch-->>AgentLoop: Memory Context
    
    AgentLoop->>Perception: Analyze Query + Memory
    Perception-->>AgentLoop: Perception Result
    
    alt Goal Already Achieved
        AgentLoop->>CSVManager: Log Success (No Steps)
        AgentLoop-->>User: Return Final Answer
    else Need Planning
        AgentLoop->>Decision: Create Initial Plan
        Decision-->>AgentLoop: Plan with Steps
        
        loop For Each Step (Up to MAX_STEPS)
            AgentLoop->>ControlManager: Check Step Limit
            ControlManager-->>AgentLoop: Limit Status
            
            alt Step Limit Reached
                AgentLoop->>Decision: Generate Suggested Plan
                Decision-->>AgentLoop: Suggested Plan
                AgentLoop->>HumanLoop: Request Plan Modification
                HumanLoop->>User: Present Context + Suggestion
                User-->>HumanLoop: Provide New Plan
                HumanLoop-->>AgentLoop: User Plan
                AgentLoop->>AgentLoop: Create CONCLUDE Step
            end
            
            AgentLoop->>Executor: Execute Step
            Executor->>MCP: Call Tool
            
            loop Retry Loop (Up to MAX_RETRIES)
                alt Tool Success
                    MCP-->>Executor: Success Result
                else Tool Failure
                    MCP-->>Executor: Error
                    Executor->>Executor: Increment Retry Count
                    alt Retries Exhausted
                        Executor->>HumanLoop: Request Tool Result
                        HumanLoop->>User: Present Error Context
                        User-->>HumanLoop: Provide Result
                        HumanLoop-->>Executor: User Result
                    end
                end
            end
            
            Executor-->>AgentLoop: Execution Result
            
            AgentLoop->>SessionLog: Update Session State
            AgentLoop->>Perception: Evaluate Step Result
            Perception-->>AgentLoop: Perception Snapshot
            
            alt Goal Achieved
                AgentLoop->>CSVManager: Log Success
                AgentLoop-->>User: Return Final Answer
            else Continue
                AgentLoop->>Decision: Plan Next Step
                Decision-->>AgentLoop: Next Step Plan
            end
        end
    end
    
    AgentLoop->>CSVManager: Log Final Performance
    CSVManager->>PerfCSV: Write Performance Data

========================================
DIAGRAM 3: Tool Execution with Retry
========================================
Copy everything below this line into Mermaid Live:

flowchart TD
    Start([Start Tool Execution]) --> Init[Initialize Retry Count = 0]
    Init --> Execute[Execute Tool via MCP]
    
    Execute --> CheckSuccess{Execution<br/>Successful?}
    
    CheckSuccess -->|Yes| LogSuccess[Log Success to CSV]
    LogSuccess --> ReturnSuccess[Return Success Result]
    ReturnSuccess --> End([End])
    
    CheckSuccess -->|No| CatchError[Capture Error]
    CatchError --> IncrementRetry[Increment Retry Count]
    IncrementRetry --> CheckRetryLimit{Retry Count<br/>< MAX_RETRIES?}
    
    CheckRetryLimit -->|Yes| Sleep[Sleep 1 Second]
    Sleep --> Execute
    
    CheckRetryLimit -->|No| AllRetriesFailed[All Retries Exhausted]
    AllRetriesFailed --> BuildContext[Build Error Context:<br/>- Tool Name<br/>- Error Message<br/>- Step Description<br/>- Query]
    
    BuildContext --> TriggerHIL[Trigger Human-in-Loop]
    TriggerHIL --> PresentError[Present to User:<br/>- Tool Name<br/>- Error Details<br/>- Expected Result]
    
    PresentError --> UserInput{User Provides<br/>Result?}
    
    UserInput -->|Yes| GetUserResult[Get User Result]
    GetUserResult --> MarkHumanProvided[Mark as Human-Provided]
    MarkHumanProvided --> LogWithHIL[Log to CSV with<br/>human_provided=True]
    LogWithHIL --> ReturnUserResult[Return User Result as Success]
    ReturnUserResult --> End
    
    UserInput -->|No| ReturnError[Return Error Result]
    ReturnError --> End
    
    style AllRetriesFailed fill:#e74c3c,color:#fff
    style TriggerHIL fill:#e74c3c,color:#fff
    style ReturnSuccess fill:#27ae60,color:#fff
    style ReturnUserResult fill:#27ae60,color:#fff

========================================
DIAGRAM 4: Plan Failure and Human-in-Loop
========================================
Copy everything below this line into Mermaid Live:

flowchart TD
    Start([Agent Loop Running]) --> ExecuteStep[Execute Current Step]
    ExecuteStep --> EvaluateStep[Evaluate Step Result]
    
    EvaluateStep --> CheckGoal{Goal<br/>Achieved?}
    
    CheckGoal -->|Yes| LogSuccess[Log Success to CSV]
    LogSuccess --> ReturnAnswer[Return Final Answer]
    ReturnAnswer --> End([End])
    
    CheckGoal -->|No| CheckUnhelpful{Step<br/>Unhelpful?}
    
    CheckUnhelpful -->|No| Continue[Continue to Next Step]
    Continue --> CheckStepLimit{Step Index<br/>< MAX_STEPS?}
    
    CheckStepLimit -->|Yes| ExecuteStep
    CheckStepLimit -->|No| PlanLimitReached[Step Limit Reached]
    
    CheckUnhelpful -->|Yes| PlanFailed[Plan Failed - Step Unhelpful]
    
    PlanLimitReached --> BuildContext[Build Failure Context:<br/>- Reason<br/>- Current Plan<br/>- Step Count<br/>- Query]
    PlanFailed --> BuildContext
    
    BuildContext --> GetSuggestion[Get Suggested Plan from Decision]
    GetSuggestion --> PresentToUser[Present to User:<br/>- Failure Reason<br/>- Current Plan<br/>- Suggested Plan]
    
    PresentToUser --> UserChoice{User Choice}
    
    UserChoice -->|Accept Suggested| UseSuggested[Use Suggested Plan]
    UserChoice -->|Modify| GetModified[Get Modified Plan from User]
    UserChoice -->|Custom| GetCustom[Get Custom Plan from User]
    UserChoice -->|No Input| UseConclude[Use Default: Conclude]
    
    UseSuggested --> CreateStep[Create CONCLUDE Step]
    GetModified --> CreateStep
    GetCustom --> CreateStep
    UseConclude --> CreateStep
    
    CreateStep --> UpdateSession[Update Session with New Plan]
    UpdateSession --> MarkComplete[Mark Session Complete]
    MarkComplete --> LogToCSV[Log to CSV with Final State]
    LogToCSV --> End
    
    style PlanLimitReached fill:#e74c3c,color:#fff
    style PlanFailed fill:#e74c3c,color:#fff
    style PresentToUser fill:#e74c3c,color:#fff
    style MarkComplete fill:#27ae60,color:#fff

========================================
DIAGRAM 5: High-Level Conceptual Architecture
========================================
Copy everything below this line into Mermaid Live:

graph TB
    subgraph "Human Layer"
        Human[Human User<br/>Query Provider & Supervisor]
    end
    
    subgraph "Intelligence Layer"
        Agent[Intelligent Agent<br/>Autonomous Decision Maker]
        Perception[Understanding<br/>What does the user want?]
        Planning[Strategy<br/>How to achieve the goal?]
    end
    
    subgraph "Execution Layer"
        Tools[Tool Ecosystem<br/>Code Execution & MCP Servers]
        Retry[Resilience<br/>Automatic Recovery]
    end
    
    subgraph "Oversight Layer"
        Limits[Execution Limits<br/>MAX_STEPS & MAX_RETRIES]
        HumanLoop[Human Intervention<br/>When AI Needs Help]
    end
    
    subgraph "Memory Layer"
        Context[Context Memory<br/>Past Experiences]
        Learning[Learning<br/>From History]
    end
    
    subgraph "Observability Layer"
        Logging[Comprehensive Logging<br/>CSV Performance Tracking]
        Analytics[Performance Analytics<br/>Success Rates & Insights]
    end
    
    Human -->|Query| Agent
    Agent --> Perception
    Perception --> Planning
    Planning --> Tools
    
    Tools -->|Failure| Retry
    Retry -->|Exhausted| HumanLoop
    HumanLoop -->|Guidance| Human
    Human -->|Result/Plan| Agent
    
    Agent -->|Check| Limits
    Limits -->|Limit Reached| HumanLoop
    
    Agent --> Context
    Context --> Learning
    Learning --> Agent
    
    Agent --> Logging
    Logging --> Analytics
    Analytics -->|Insights| Human
    
    Agent -->|Final Answer| Human
    
    style Agent fill:#4a90e2,color:#fff
    style HumanLoop fill:#e74c3c,color:#fff
    style Limits fill:#f39c12,color:#fff
    style Logging fill:#27ae60,color:#fff
    style Context fill:#9b59b6,color:#fff

========================================
DIAGRAM 6: Agent Lifecycle State Diagram
========================================
Copy everything below this line into Mermaid Live:

stateDiagram-v2
    [*] --> QueryReceived: User Submits Query
    
    QueryReceived --> MemorySearch: Register Query
    MemorySearch --> Perception: Retrieve Context
    
    Perception --> GoalCheck: Analyze Intent
    
    GoalCheck --> Planning: Goal Not Achieved
    GoalCheck --> AnswerReady: Goal Already Achieved
    
    Planning --> StepExecution: Create Plan
    
    StepExecution --> StepLimitCheck: Execute Step
    
    StepLimitCheck --> HumanIntervention: Limit Reached
    StepLimitCheck --> StepEvaluation: Within Limits
    
    StepEvaluation --> GoalCheck: Evaluate Result
    
    StepExecution --> RetryCheck: Tool Execution
    
    RetryCheck --> RetryExecution: Retries Available
    RetryCheck --> HumanIntervention: Retries Exhausted
    
    RetryExecution --> RetryCheck: Retry Tool
    
    HumanIntervention --> Planning: User Provides Plan
    HumanIntervention --> AnswerReady: User Provides Result
    
    AnswerReady --> Logging: Prepare Final Answer
    Logging --> [*]: Return Answer

========================================
DIAGRAM 7: Information Flow
========================================
Copy everything below this line into Mermaid Live:

flowchart TD
    subgraph "Input"
        I1[User Query<br/>Natural Language]
    end
    
    subgraph "Understanding"
        U1[Perception<br/>Intent Extraction]
        U2[Memory Search<br/>Context Retrieval]
        U3[Goal Analysis<br/>Achievement Check]
    end
    
    subgraph "Planning"
        P1[Decision Module<br/>Strategy Selection]
        P2[Plan Generation<br/>Step Sequence]
        P3[Plan Validation<br/>Feasibility Check]
    end
    
    subgraph "Execution"
        E1[Tool Selection<br/>MCP Server Choice]
        E2[Code Execution<br/>Python Runtime]
        E3[Result Capture<br/>Output Collection]
    end
    
    subgraph "Evaluation"
        V1[Step Assessment<br/>Helpfulness Check]
        V2[Goal Progress<br/>Achievement Status]
        V3[Plan Adjustment<br/>Replanning Decision]
    end
    
    subgraph "Recovery"
        R1[Retry Logic<br/>Automatic Retry]
        R2[Human Intervention<br/>Tool Recovery]
        R3[Plan Modification<br/>Human Guidance]
    end
    
    subgraph "Output"
        O1[Final Answer<br/>User Response]
        O2[Performance Log<br/>CSV Records]
        O3[Statistics<br/>Analytics Report]
    end
    
    I1 --> U1
    I1 --> U2
    U2 --> U1
    U1 --> U3
    
    U3 --> P1
    P1 --> P2
    P2 --> P3
    
    P3 --> E1
    E1 --> E2
    E2 --> E3
    
    E3 --> V1
    V1 --> V2
    V2 --> V3
    
    V3 -->|Continue| E1
    V3 -->|Retry Needed| R1
    V3 -->|Recovery Needed| R2
    V3 -->|Plan Change| R3
    
    R1 --> E2
    R2 --> E3
    R3 --> P2
    
    V2 -->|Goal Achieved| O1
    V2 -->|Complete| O2
    O2 --> O3
    
    style U1 fill:#3498db,color:#fff
    style P1 fill:#9b59b6,color:#fff
    style E2 fill:#e74c3c,color:#fff
    style R2 fill:#e74c3c,color:#fff
    style R3 fill:#e74c3c,color:#fff
    style O1 fill:#27ae60,color:#fff

========================================
INSTRUCTIONS FOR MERMAID LIVE
========================================
1. Go to https://mermaid.live/
2. Copy ONLY the diagram code (without the ```mermaid markers)
3. Paste into the editor
4. The diagram will render automatically

IMPORTANT: Do NOT copy the markdown code block markers (```mermaid and ```)
Only copy the actual diagram code between those markers.

